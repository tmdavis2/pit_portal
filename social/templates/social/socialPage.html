{% extends "pages/home.html" %}
{% block content %}
<main>
    <div class="social-page-container">
        <aside class="social-sidebar">
            <h3>Previous Chats</h3>
            <div class="previous-chats-container">
                <ul>
                    {% for room in previous_rooms %}
                        <li>
                            <a href="{% url 'room' room.room_name %}">
                                {{ room.display_name }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>

        <div class="social-main-content">
            <div class="card">
                <h1><i class="fa-solid fa-comment"></i> Social Hub</h1>
                <p class="hero-subtitle">Connect with fellow gamers</p>
                
                <div class="social-content">
                    <div class="social-section">
                        <h2>Join a Chat Room</h2>
                        <p>Enter a room name to join an existing chat or create a new one.</p>
                        <input id="room-name-input" type="text" placeholder="Room name" class="form-input">
                        <button id="room-name-submit" class="card-link">Enter Room</button>
                    </div>
                    
                    <div class="social-section">
                        <h2>Start a Direct Chat</h2>
                        <p>Search for a user to start a private conversation.</p>
                        <input id="user-search-input" type="text" placeholder="Search for a user..." class="form-input">
                        <ul id="user-results"></ul>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</main>

<script>
    document.querySelector('#room-name-input').focus();
    document.querySelector('#room-name-input').onkeyup = function(e) {
        if (e.key === 'Enter') document.querySelector('#room-name-submit').click();
    };

    document.querySelector('#room-name-submit').onclick = function() {
        var roomName = document.querySelector('#room-name-input').value;
        if (roomName.trim()) {
            window.location.pathname = '/social/' + roomName + '/';
        }
    };

    const userSearchInput = document.querySelector('#user-search-input');
    const userResults = document.querySelector('#user-results');
    let debounceTimer;

    userSearchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        if (query.length < 2) {
            userResults.innerHTML = '';
            return;
        }
        debounceTimer = setTimeout(() => {
            fetch(`/social/search-users/?q=${encodeURIComponent(query)}`, {credentials: 'same-origin'})
                .then(response => response.json())
                .then(data => {
                    userResults.innerHTML = '';
                    data.users.forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = user.username;
                        li.addEventListener('click', () => {
                            const currentUser = '{{ request.user.username }}';
                            const roomName = `dm_${[currentUser, user.username].sort().join('_')}`;
                            window.location.pathname = `/social/${roomName}/`;
                        });
                        userResults.appendChild(li);
                    });
                })
                .catch(console.error);
        }, 300);
    });
</script>

<style>
    /* Container Grid Layout */
    .social-page-container {
        display: grid;
        grid-template-columns: 1fr 2fr; /* sidebar 1 / main 2 */
        gap: 32px;
        max-width: 1400px;
        width: 100%;
        margin: 0 auto;
        padding: 16px;
    }

    .social-sidebar {
        background: rgba(20, 20, 20, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        border: 1px solid rgba(48,4,153,0.4);
        height: fit-content;
    }

    .social-sidebar h3 {
        color: #a855f7;
        margin-bottom: 16px;
        font-size: 1.2rem;
    }

    .social-sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .social-sidebar li {
        margin-bottom: 8px;
    }

    .social-sidebar a {
        color: #e0e0e0;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .social-sidebar a:hover {
        background: rgba(48, 4, 153, 0.2);
        color: #fff;
    }

    .social-main-content .card {
        background: rgba(20,20,20,0.8);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        border: 1px solid rgba(48,4,153,0.4);
        color: #e0e0e0;
    }

    .social-content {
        text-align: left;
        max-width: 600px;
        margin: 0 auto;
    }

    .social-section {
        margin-bottom: 40px;
    }

    .social-section h2 {
        color: #a855f7;
        margin-bottom: 10px;
    }

    .social-section p {
        color: #b0b0b0;
        margin-bottom: 20px;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(48,4,153,0.3);
        margin-bottom: 12px;
        background: rgba(30,30,30,0.8);
        color: #fff;
    }

    #room-name-submit {
        display: inline-block;
        padding: 10px 20px;
        background: linear-gradient(135deg, #300499 0%, #6b21a8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    #room-name-submit:hover {
        background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
    }

    #user-results {
        list-style: none;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid rgba(48, 4, 153, 0.3);
        border-radius: 8px;
        background: rgba(30,30,30,0.8);
    }

    #user-results li {
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid rgba(48, 4, 153, 0.2);
        transition: background 0.3s ease;
    }

    #user-results li:hover {
        background: rgba(48, 4, 153, 0.1);
    }

    /* Responsive: stack cards on smaller screens */
    @media (max-width: 1024px) {
        .social-page-container {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .social-sidebar, .social-main-content .card {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
    }

    @media (max-width: 600px) {
        .social-section h2 {
            font-size: 1.2rem;
        }

        .social-main-content .card {
            padding: 16px;
        }

        #room-name-submit {
            width: 100%;
        }
    }
</style>
{% endblock %}
